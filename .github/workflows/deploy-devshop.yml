name: Build and Deploy devShop

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/devShop/**'
      - '.github/workflows/deploy-devshop.yml'

env:
  AZURE_RESOURCE_GROUP: rg-devShop
  WEB_VM_NAME: vm-web-devShop
  DOTNET_VERSION: '4.8'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore src/devShop.sln
    
    - name: Build solution
      run: msbuild src/devShop.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployOnBuild=false
    
    - name: Verify build output
      shell: pwsh
      run: |
        Write-Host "Checking build output:"
        if (Test-Path "src/devShop/bin/Release") {
          Write-Host "‚úì bin/Release folder exists"
          Get-ChildItem "src/devShop/bin/Release" | Select-Object Name, Length
        } else {
          Write-Host "‚úó bin/Release folder NOT found"
          Write-Host "Searching for bin folder:"
          Get-ChildItem "src/devShop" -Directory -Recurse -Filter "bin" | Select-Object FullName
        }
    
    - name: Prepare deployment package
      shell: pwsh
      run: |
        $publishDir = "publish"
        New-Item -ItemType Directory -Path $publishDir -Force
        
        # Copy all application files from src/devShop INCLUDING bin folder this time
        Write-Host "Copying application files with bin folder..."
        Copy-Item -Path "src/devShop/*" -Destination $publishDir -Recurse -Exclude @('obj', '*.csproj.user', 'packages')
        
        Write-Host "`nVerifying bin folder in publish directory:"
        if (Test-Path "$publishDir/bin") {
          Write-Host "‚úì bin folder exists"
          Get-ChildItem "$publishDir/bin" -File | Select-Object Name, Length | Format-Table
        } else {
          throw "ERROR: bin folder not copied!"
        }
        
        Write-Host "`nChecking for devShop.dll:"
        $dll = Get-ChildItem "$publishDir/bin" -Filter "devShop.dll" -ErrorAction SilentlyContinue
        if ($dll) {
          Write-Host "‚úì devShop.dll found: $($dll.Length) bytes"
        } else {
          Write-Host "‚úó devShop.dll NOT found!"
          Write-Host "All DLLs in bin:"
          Get-ChildItem "$publishDir/bin" -Filter "*.dll" | Select-Object Name
        }
    
    - name: Create deployment package
      shell: pwsh
      run: |
        Compress-Archive -Path "publish\*" -DestinationPath "built-app.zip" -Force
        Write-Host "Package created: $(Get-Item built-app.zip | Select-Object Name, Length)"        
        # Verify ZIP contents
        Write-Host "`nVerifying ZIP contents:"
        Add-Type -AssemblyName System.IO.Compression.FileSystem
        $zip = [System.IO.Compression.ZipFile]::OpenRead("built-app.zip")
        $binFiles = $zip.Entries | Where-Object { $_.FullName -like "bin/*" }
        Write-Host "Files in bin folder within ZIP:"
        $binFiles | Select-Object FullName, Length | Format-Table
        $zip.Dispose()
        
        if ($binFiles.Count -eq 0) {
          throw "ERROR: bin folder not in ZIP file!"
        }
        Write-Host "‚úì ZIP file contains $($binFiles.Count) files in bin folder"    
    - name: Azure Login
      shell: pwsh
      run: |
        $creds = '${{ secrets.AZURE_CREDENTIALS }}' | ConvertFrom-Json
        az login --service-principal `
          --username $creds.clientId `
          --password $creds.clientSecret `
          --tenant $creds.tenantId
        az account set --subscription $creds.subscriptionId
        
        # Save credentials to environment for later steps
        "AZURE_CLIENT_ID=$($creds.clientId)" >> $env:GITHUB_ENV
        "AZURE_RESOURCE_GROUP=${{ secrets.RESOURCE_GROUP }}" >> $env:GITHUB_ENV
    
    - name: Enable OpenSSH on VM
      shell: pwsh
      run: |
        $resourceGroup = 'rg-devShop'
        $vmName = 'vm-web-devShop'
        $sshUser = '${{ secrets.SSH_USERNAME }}'
        $pubKey  = '${{ secrets.SSH_PUBLIC_KEY }}'

        if (-not $sshUser -or -not $pubKey) { throw "Missing SSH_USERNAME or SSH_PUBLIC_KEY secrets" }

        # For admin users, use ProgramData\ssh\administrators_authorized_keys
        $script = '$ErrorActionPreference=''Stop'';$p=''' + $pubKey + ''';Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0 | Out-Null;Set-Service -Name sshd -StartupType Automatic;Start-Service sshd;$auth=''C:\ProgramData\ssh\administrators_authorized_keys'';Set-Content -Path $auth -Value $p -Encoding ascii;icacls $auth /inheritance:r /grant ''Administrators:F'' /grant ''SYSTEM:F'' | Out-Null;Write-Host ''OpenSSH ready'''

        # Retry loop to handle "run command in progress" conflicts
        $maxRetries = 5
        for ($i = 1; $i -le $maxRetries; $i++) {
          Write-Host "Attempt $i of $maxRetries..."
          $result = az vm run-command invoke --resource-group $resourceGroup --name $vmName --command-id RunPowerShellScript --scripts $script 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host $result
            break
          }
          if ($result -like "*in progress*" -and $i -lt $maxRetries) {
            Write-Host "VM busy, waiting 60 seconds..."
            Start-Sleep -Seconds 60
          } else {
            Write-Host $result
            if ($i -eq $maxRetries) { throw "Failed after $maxRetries attempts" }
          }
        }

    - name: Copy package via SCP
      shell: pwsh
      run: |
        $resourceGroup = 'rg-devShop'
        $vmName = 'vm-web-devShop'
        $sshUser = '${{ secrets.SSH_USERNAME }}'
        $privKey = '${{ secrets.SSH_PRIVATE_KEY }}'

        if (-not $sshUser -or -not $privKey) { throw "Missing SSH_USERNAME or SSH_PRIVATE_KEY secrets" }

        # Write private key to file with correct permissions
        $keyPath = "$env:USERPROFILE\.ssh\deploy_rsa"
        New-Item -ItemType Directory -Path (Split-Path $keyPath) -Force | Out-Null
        Set-Content -Path $keyPath -Value $privKey -Encoding ascii
        # Use attrib instead of icacls to avoid PowerShell parsing issues
        attrib +R $keyPath

        # Get VM IP
        $ip = az vm show -d --resource-group $resourceGroup --name $vmName --query "publicIps" -o tsv
        if (-not $ip) { throw "VM IP not found" }

        # Get runner's public IP and add to NSG
        $runnerIp = (Invoke-RestMethod -Uri 'https://api.ipify.org')
        Write-Host "Adding runner IP $runnerIp to NSG..."
        az network nsg rule create --resource-group $resourceGroup --nsg-name nsg-web-devShop --name AllowSSH-Runner --priority 110 --direction Inbound --access Allow --protocol Tcp --destination-port-ranges 22 --source-address-prefixes "$runnerIp/32" --output none 2>$null
        Start-Sleep -Seconds 5

        # Create package
        Compress-Archive -Path "publish\*" -DestinationPath "built-app.zip" -Force

        Write-Host "Copying package to VM via scp..."
        $dest = "${sshUser}@${ip}:/c:/Temp/built-app.zip"
        scp -i $keyPath -o StrictHostKeyChecking=no -o ConnectTimeout=30 "built-app.zip" $dest

    - name: Deploy on VM
      shell: pwsh
      run: |
        $resourceGroup = 'rg-devShop'
        $vmName = 'vm-web-devShop'
        
        $cmd = "`$ErrorActionPreference='Stop';`$app='C:\inetpub\wwwroot\devShop';Import-Module WebAdministration;Stop-WebAppPool -Name 'devShopPool' -ErrorAction SilentlyContinue;Start-Sleep -Seconds 2;if(Test-Path `$app){Remove-Item `"`$app\*`" -Recurse -Force}else{New-Item -ItemType Directory -Path `$app -Force|Out-Null};Expand-Archive -Path 'C:\Temp\built-app.zip' -DestinationPath `$app -Force;icacls `$app /grant 'IIS_IUSRS:(OI)(CI)RX' /T|Out-Null;icacls `$app /grant 'IUSR:(OI)(CI)RX' /T|Out-Null;if(Test-Path `"`$app\App_Data`" ){icacls `"`$app\App_Data`" /grant 'IIS_IUSRS:(OI)(CI)F' /T|Out-Null};Start-WebAppPool -Name 'devShopPool';Start-Website -Name 'devShop' -ErrorAction SilentlyContinue;Write-Host 'Deployed';Get-ChildItem `"`$app\bin`" -ErrorAction SilentlyContinue | Select Name,Length | % { Write-Host `"  `$( `$_ .Name) - `$( `$_ .Length)b`" }"

        az vm run-command invoke --resource-group $resourceGroup --name $vmName --command-id RunPowerShellScript --scripts $cmd
    
    - name: Verify deployment
      shell: pwsh
      run: |
        $webUrl = az vm show -d --resource-group $env:AZURE_RESOURCE_GROUP --name $env:WEB_VM_NAME --query "publicIps" -o tsv
        $url = "http://$webUrl"
        
        Write-Host "Waiting for application to start..."
        Start-Sleep -Seconds 5
        
        try {
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
          Write-Host "‚úÖ Deployment successful! Status: $($response.StatusCode)"
          Write-Host "üåê Application URL: $url"
        } catch {
          Write-Host "‚ö†Ô∏è Application deployed but may need time to start: $_"
          Write-Host "üåê Check manually: $url"
        }
