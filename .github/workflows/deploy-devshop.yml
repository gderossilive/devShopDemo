name: Build and Deploy devShop

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'src/devShop/**'
      - '.github/workflows/deploy-devshop.yml'

env:
  AZURE_RESOURCE_GROUP: rg-devShop
  WEB_VM_NAME: vm-web-devShop
  DOTNET_VERSION: '4.8'

jobs:
  build-and-deploy:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v1.1
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v1
    
    - name: Restore NuGet packages
      run: nuget restore src/devShop/devShop.csproj -PackagesDirectory src/devShop/packages
    
    - name: Build solution
      run: msbuild src/devShop/devShop.csproj /p:Configuration=Release /p:DeployOnBuild=false /p:Platform=AnyCPU
    
    - name: Prepare deployment package
      shell: pwsh
      run: |
        $publishDir = "publish"
        New-Item -ItemType Directory -Path $publishDir -Force
        
        # Copy all necessary files
        Copy-Item -Path "src/devShop/*" -Destination $publishDir -Recurse -Exclude @('obj', '*.csproj.user', 'packages')
        
        Write-Host "Files prepared for deployment"
        Get-ChildItem $publishDir -Recurse | Select-Object FullName
    
    - name: Create deployment package
      shell: pwsh
      run: |
        Compress-Archive -Path "publish/*" -DestinationPath "devShop-app.zip" -Force
        Write-Host "Package created: $(Get-Item devShop-app.zip | Select-Object Name, Length)"
    
    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
    
    - name: Upload package to VM and deploy
      shell: pwsh
      run: |
        # Convert zip to base64 for transfer (smaller files)
        $zipBytes = [System.IO.File]::ReadAllBytes("devShop-app.zip")
        $base64Zip = [System.Convert]::ToBase64String($zipBytes)
        
        # Split into chunks if needed (Azure run-command has limits)
        $chunkSize = 100000
        if ($base64Zip.Length -gt $chunkSize) {
          Write-Host "Package too large, using alternative method..."
          
          # Use Azure Storage for large files
          $storageAccount = az storage account list --resource-group $env:AZURE_RESOURCE_GROUP --query "[0].name" -o tsv
          
          az storage blob upload `
            --account-name $storageAccount `
            --container-name scripts `
            --name "devShop-app.zip" `
            --file "devShop-app.zip" `
            --auth-mode login `
            --overwrite true
          
          $expiryTime = (Get-Date).AddHours(1).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")
          $sasToken = az storage blob generate-sas `
            --account-name $storageAccount `
            --container-name scripts `
            --name "devShop-app.zip" `
            --permissions r `
            --expiry $expiryTime `
            --auth-mode login `
            --as-user `
            --https-only `
            --output tsv
          
          $blobUrl = "https://$storageAccount.blob.core.windows.net/scripts/devShop-app.zip?$sasToken"
          
          $deployScript = @"
          `$ErrorActionPreference = 'Stop'
          Write-Host 'Downloading application package...'
          
          `$zipPath = 'C:\Temp\devShop-app.zip'
          `$appPath = 'C:\inetpub\wwwroot\devShop'
          
          New-Item -ItemType Directory -Path 'C:\Temp' -Force | Out-Null
          
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri '$blobUrl' -OutFile `$zipPath -UseBasicParsing
          
          Write-Host 'Stopping IIS...'
          Import-Module WebAdministration
          Stop-WebAppPool -Name 'devShopPool' -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          Write-Host 'Extracting application...'
          if (Test-Path `$appPath) {
            Remove-Item "`$appPath\*" -Recurse -Force -ErrorAction SilentlyContinue
          }
          New-Item -ItemType Directory -Path `$appPath -Force | Out-Null
          
          Expand-Archive -Path `$zipPath -DestinationPath `$appPath -Force
          
          Write-Host 'Setting permissions...'
          icacls `$appPath /grant 'IIS_IUSRS:(OI)(CI)RX' /T | Out-Null
          icacls `$appPath /grant 'IUSR:(OI)(CI)RX' /T | Out-Null
          if (Test-Path "`$appPath\App_Data") {
            icacls "`$appPath\App_Data" /grant 'IIS_IUSRS:(OI)(CI)F' /T | Out-Null
          }
          
          Write-Host 'Starting IIS...'
          Start-WebAppPool -Name 'devShopPool'
          Start-Website -Name 'devShop' -ErrorAction SilentlyContinue
          
          Remove-Item `$zipPath -Force -ErrorAction SilentlyContinue
          
          Write-Host 'Deployment complete!'
          Write-Host "Files in bin folder: `$((Get-ChildItem `$appPath\bin -ErrorAction SilentlyContinue | Measure-Object).Count)"
          "@
          
          Write-Host "Deploying to VM..."
          az vm run-command invoke `
            --resource-group $env:AZURE_RESOURCE_GROUP `
            --name $env:WEB_VM_NAME `
            --command-id RunPowerShellScript `
            --scripts $deployScript
        } else {
          Write-Host "Using direct transfer method..."
          
          $deployScript = @"
          `$ErrorActionPreference = 'Stop'
          Write-Host 'Deploying application...'
          
          `$appPath = 'C:\inetpub\wwwroot\devShop'
          `$zipPath = 'C:\Temp\devShop-app.zip'
          
          New-Item -ItemType Directory -Path 'C:\Temp' -Force | Out-Null
          
          # Decode base64 and save
          `$zipBytes = [System.Convert]::FromBase64String('$base64Zip')
          [System.IO.File]::WriteAllBytes(`$zipPath, `$zipBytes)
          
          Import-Module WebAdministration
          Stop-WebAppPool -Name 'devShopPool' -ErrorAction SilentlyContinue
          Start-Sleep -Seconds 2
          
          if (Test-Path `$appPath) {
            Remove-Item "`$appPath\*" -Recurse -Force -ErrorAction SilentlyContinue
          }
          New-Item -ItemType Directory -Path `$appPath -Force | Out-Null
          
          Expand-Archive -Path `$zipPath -DestinationPath `$appPath -Force
          
          icacls `$appPath /grant 'IIS_IUSRS:(OI)(CI)RX' /T | Out-Null
          icacls `$appPath /grant 'IUSR:(OI)(CI)RX' /T | Out-Null
          
          Start-WebAppPool -Name 'devShopPool'
          Start-Website -Name 'devShop' -ErrorAction SilentlyContinue
          
          Write-Host 'Deployment complete!'
          "@
          
          az vm run-command invoke `
            --resource-group $env:AZURE_RESOURCE_GROUP `
            --name $env:WEB_VM_NAME `
            --command-id RunPowerShellScript `
            --scripts $deployScript
        }
    
    - name: Verify deployment
      shell: pwsh
      run: |
        $webUrl = az vm show -d --resource-group $env:AZURE_RESOURCE_GROUP --name $env:WEB_VM_NAME --query "publicIps" -o tsv
        $url = "http://$webUrl"
        
        Write-Host "Waiting for application to start..."
        Start-Sleep -Seconds 5
        
        try {
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 10
          Write-Host "‚úÖ Deployment successful! Status: $($response.StatusCode)"
          Write-Host "üåê Application URL: $url"
        } catch {
          Write-Host "‚ö†Ô∏è Application deployed but may need time to start: $_"
          Write-Host "üåê Check manually: $url"
        }
